## Лабораторная работа № 6.
## Virtual Private Network. IPsec Site-to-Site VPN

## Оглавление:
- [Цель работы](#section1)
- [Требования](#section1.2)
- [Краткие теоретические сведения](#section1.3)
- [Ход работы](#section1.5)
  - [Часть 1. Настройка VPN на роутерах, на основе лабораторной работы 4.](#section2)
  - [Часть 2. Настройка VPN на Cisco ASA, на основе лабораторной работы 5.](#section2.1)
- [Вывод](#section3)

## <a name="section1">Цель работы</a>  
Обеспечить безопасное соединение двух зданий через внешнюю (городскую) сеть.

## <a name="section1.2">Требования</a> 

Для выполнения работы необходима установленная среда моделирования Cisco Packet Tracer и выполненные предыдущие лабораторные работы. 

## <a name="section1.3">Краткие теоретические сведения</a>   

А) Собственноручно строить физический канал. Тогда это может быть:

    1. Ethernet – витая пара. До 100 метров. Максимум по зданию или между соседними строениями. Скорость до 1 Гбит/c (Строго говоря, есть стандарт 10GBASE-T, позволяющий на том же расстоянии передавать данные на скорости 10Гбит/с).
    2. WiFi. Расстояние зависит от реализации: можно добиться работоспособности на 40 км при использовании мощных направленных антенн. В среднем до 5 км при прямой видимости. Скорость зависит от используемого стандарта и от расстояния. Необходимо регистрировать в “Роскомнадзоре”, а при больших мощностях излучения и получать разрешение на включение.
    3. xDSL – два-четыре провода. Скорость зависит от расстояния (теоретический максимум 250 Мбит/с, расстояние до 6 км). Хотя ходят слухи о разработке стандарта 1Гб/c по двум проводам. Или подключение к интернету через xDSL, а именно линк: модеммодем. Да, и такие решения существуют. Можно назвать это мостом. Это, несомненно, архаика, которая, тем не менее, может встречаться в РФ, учитывая огромные расстояния и удаленность от цивилизации.
    4. Радио-Релейные Линии. Расстояние до нескольких десятков километров. Скорость до 600 Мб/с. Но это решение уже операторского уровня, поскольку требует массу согласований и мероприятий по планированию, строительству, вводу в эксплуатацию.
    5. Оптоволокно. 1Гб/с (решения на 10 и 100 Гб/с могут стоить неоправданно дорого). Расстояние зависит от многих факторов: от нескольких километров до сотен. Необходимы согласования по прокладке кабеля, квалифицированный персонал для строительства и обслуживания. Для небольших компаний есть смысл только для подключения здания не очень далеко от центрального узла. Вообще, конечно, каждый случай индивидуален и требует расчёта.

В этом случае всё прозрачно – используется своя собственная физическая линия, поэтому пропускать через неё можете что угодно без ограничений.

Б) Второй вариант – арендовать канал у провайдера. В случае необходимости стабильного канала до другого города – это самый распространённый и надёжный вариант. Провайдер может вам предоставить следующие услуги:


    1. Самый настоящий прямой кабель. Например, он может дать вам взаймы одно-два тёмных  (неиспользуемых резервных) волокна из своего оптического пучка. Вы вольны отправлять в него всё, что вашей душе угодно. Со стороны провайдера это никак не контролируется, не ограничивается, он осуществляет только поддержку. Например, в случае аварии не вам придётся искать подрядчика и сварочный аппарат, а провайдеру. И за простой несёт ответственность он же. Если у вас это не по обоюдному согласию (читай, взаимозачёт), то, пожалуй, самый дорогой способ.
    2. L2VPN. Вы так же можете пускать в канал всё, что угодно, но в данном случае, ваш трафик пойдёт через активное оборудование провайдера, поэтому может ограничиваться, например, по скорости.
Под этим термином понимается сразу несколько услуг второго уровня:
VLAN – в том или ином виде между филиалами вам предоставлен VLAN.
Псевдокабель (PWE3) – это услуга Точка-Точка, когда у вас как будто бы кабель между двумя узлами. Все переданные вами фреймы без изменений доставляются до удалённой точки. Аналогично обратным образом. Это возможно благодаря тому, что ваш фрейм, приходящий на маршрутизатор провайдера инкапсулируется в PDU вышестоящего уровня, как правило, это пакет MPLS.
VPLS (Виртуальная частная сеть) – это симуляция локальной сети. В этом случае вся сеть провайдера для вас будет как некий абстрактный гигантский коммутатор. Как и настоящий он будет хранить таблицу MAC-адресов и принимать решение о том, куда отправить пришедший кадр. Реализуется это также инкапсуляцией кадра в MPLS пакет.
    3. L3VPN. В данном случае сеть провайдера – это как большой маршрутизатор с несколькими интерфейсами. То есть стык у вас будет происходить на сетевом уровне. Вы настраиваете IP-адреса на своих маршрутизаторах с обеих сторон, а вот маршрутизация в сети провайдера – это уже головная боль провайдера. IP-адреса для точек стыка можете либо определять вы, либо выдать провайдер – зависит от реализации и от вашей договорённости. Функционировать это может на основе GRE, IPSec или того же MPLS.

Эта услуга выглядит очень простой с точки зрения клиента – как в плане настройки, так и в плане реализации – но сложной – с точки зрения оператора.

В) Ну и последний вариант: туннель через публичную сеть. Предположим, у вас есть выход в Интернет на обеих ваших точках. Зачастую самым дешёвым способом оказывается построить туннель между этими двумя точками. Для этого вам достаточно всего лишь иметь белые (публичные) статические адреса на всех точках (а иногда достаточно и на одной) и оборудование, на котором это реализовать. У этого решения есть ряд недостатков, которые мы рассмотрим ниже, но тем не менее именно на нём мы сегодня и остановимся.
В этой лабораторной работе будем работать с IPsec Site-to-Site VPN.
Virtual Private Network - виртуальная частная сеть, способ защитить свой интернет-трафик и скрыть свои личные данные при работе онлайн. При подключении к безопасному VPN-серверу ваш интернет-трафик перенаправляется через зашифрованный туннель, в который никто не может заглянуть, ни хакеры, ни правительственные агентства, ни даже ваш интернет-провайдер.

IPsec — набор протоколов, который используется для аутентификации и шифрования трафика между двумя одноранговыми узлами. Три наиболее часто используемых протокола в наборе:
    • Internet Key Exchange (IKE) — выполняет «рукопожатие», обслуживание туннеля и отключение;
    • Encapsulation Security Payload (ESP) — обеспечивает целостность данных и шифрование;
    • Authentication Header (AH) — предлагает только целостность данных, но не шифрование.

## <a name="section1.5">Ход работы</a>  

## <a name="section2">Часть 1. Настройка VPN на роутерах, на основе лабораторной работы 4.</a>  

Была удалена связь с офисами и поставлен во 2-ом офисе роутер.

<p align=center><img src="https://github.com/DeFomin/2023-2024-computer-networks-k33212-fomintsev-d-r/assets/90705279/c4abe920-84a4-4043-aecc-41c5293a8bef" width=700></p>

* Настройка VPN включает две фазы: создание технологического тоннеля и IP-сек тоннеля.
* Настройка VPN на роутере включает создание политики, криптокарты, аксесс-листа и привязка криптокарты к интерфейсу.

<p align=center><img src="https://github.com/DeFomin/2023-2024-computer-networks-k33212-fomintsev-d-r/assets/90705279/0f2526e6-2940-47ab-acb5-b74c22a0d49a" width=700></p>

* Соответственно был исправлен nat, что бы трафик, который идет ко второму роутеру через интернет не "натился"

<p align=center><img src="https://github.com/DeFomin/2023-2024-computer-networks-k33212-fomintsev-d-r/assets/90705279/43ded8bc-3d60-47cd-a6ac-341017b7e79e" width=700></p>

* Аналогичные настройки были проделаны со вторым роутером, за исключением адреса назначения, теперь таковым является первый роутер

* PC1 -> PC2

<p align=center><img src="https://github.com/DeFomin/2023-2024-computer-networks-k33212-fomintsev-d-r/assets/90705279/aeeb9ff3-3410-43b8-8b15-e90e0064eae2" width=700></p>

* PC2 -> PC1

<p align=center><img src="https://github.com/DeFomin/2023-2024-computer-networks-k33212-fomintsev-d-r/assets/90705279/0156ca43-59e2-4ee8-a8c9-429363c6933d" width=700></p>

Интернет также доступен

<p align=center><img src="https://github.com/DeFomin/2023-2024-computer-networks-k33212-fomintsev-d-r/assets/90705279/0e7e42ff-8219-49ba-99ff-5fe0a40a70bf" width=700></p>

```show crypto isakmp sa```

SAKMP (Internet Security Association and Key Management Protocol) отвечает за установление и управление ассоциациями безопасности, которые определяют параметры безопасности для IPsec.

SA (Security Association) - это соглашение между двумя устройствами о том, как они будут обеспечивать безопасность для IPsec трафика.

## <a name="section2.1">Часть 2. Настройка VPN на Cisco ASA, на основе лабораторной работы 5.</a>  


<p align=center><img src="https://github.com/DeFomin/2023-2024-computer-networks-k33212-fomintsev-d-r/assets/90705279/a53ecfc2-249d-4587-8208-298054f11c60" width=700></p>

* Были реализованы списки доступа
```
access-list FOR-VPN: Разрешает ICMP трафик из сети 192.168.1.0/24 в сеть 192.168.2.0/24.

access-list FROM-VPN: Разрешает ICMP трафик из сети 192.168.2.0/24 в сеть 192.168.1.0/24.

access-group FROM-VPN: Применяет список доступа FROM-VPN на выходящий трафик интерфейса inside.
```

* Политики инспекции
```
class-map inspection_default и policy-map global_policy: Настройка политики инспекции ICMP трафика.
service-policy global_policy global: Применение глобальной политики инспекции.
```

* Настройки IPsec VPN

IPsec (Internet Protocol Security) VPN (Virtual Private Network) — это технология, используемая для создания безопасных туннелей для передачи данных через общедоступные сети, такие как Интернет.

crypto ipsec ikev1 transform-set TS: Настройка набора преобразований для IPsec, используя шифрование 3DES и аутентификацию HMAC MD5.

crypto map To-Site2: Создание криптокарты для VPN:

* match address FOR-VPN: Использование списка доступа FOR-VPN для определения интересующего трафика.

* set peer 210.210.2.2: Указание удаленного IP-адреса VPN-партнера.

* set security-association lifetime seconds 86400: Настройка времени жизни SA (ассоциации безопасности) на 86400 секунд (24 часа).

* set ikev1 transform-set TS: Применение набора преобразований TS.

* interface outside: Привязка криптокарты к внешнему интерфейсу outside.

crypto ikev1 enable outside: Включение IKEv1 на интерфейсе outside.

crypto ikev1 policy 1: Настройка политики IKEv1:

encr 3des: Шифрование 3DES.

hash md5: Хеширование MD5.

authentication pre-share: Предварительно разделенный ключ для аутентификации.

group 2: Группа 2 (MODP 1024-битный) для DH (Diffie-Hellman).

lifetime 43200: Время жизни политики IKE в 43200 секунд (12 часов).



<p align=center><img src="https://github.com/DeFomin/2023-2024-computer-networks-k33212-fomintsev-d-r/assets/90705279/d8e48d87-f444-4904-afae-8947765e39c0" width=700></p>


<p align=center><img src="" width=700></p>

## <a name="section3">Вывод</a>  

В ходе выполнения лабораторной работы в ее первой части была выполнена настройка VPN на роутерах, на основе лабораторной работы 4 и во второй части была выполнена настройка VPN на Cisco ASA, на основе лабораторной работы 5.

